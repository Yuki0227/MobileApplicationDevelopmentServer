name: 持续部署

on:
  push:
    branches: [ master ]
    paths:
      - src/**
      - pom.xml
  pull_request:
    branches: [ master ]

jobs:
  build:
    name: 编译&构建Docker镜像
    timeout-minutes: 6
    runs-on: ubuntu-latest
    steps:
      - name: Git Checkout Code
        uses: actions/checkout@v1
        id: git_checkout

      - name: Set up JDK 1.8
        uses: actions/setup-java@v1
        with:
          java-version: 1.8

      - name: Build with Maven
        run: mvn -B  package --file pom.xml -Dmaven.test.skip=true

      - name: Publish Docker
        uses: LucienShui/Publish-Docker-Github-Action@2.7.1
        with:
          name: registry.cn-hongkong.aliyuncs.com/android-web/spring # docker image 的名字
          username: 凯凡1423 # 用户名
          password: 001008ma # 密码
          registry: registry.cn-hongkong.aliyuncs.com # 阿里巴巴的 Docker Hub
          dockerfile: Dockerfile # 指定 Dockerfile 的位置
          tag_names: true # 是否将 release 的 tag 作为 docker image 的 tag
  
  pull-docker:
    needs: [build]
    name: 服务器启动Docker
    timeout-minutes: 6
    runs-on: ubuntu-latest
    steps:
      - name: Deploy
        uses: appleboy/ssh-action@master
        with:
          host: 8.131.250.250
          username: root
          password: Ma001008
          port: 22
          script: |
            docker stop $(docker ps --filter ancestor=registry.cn-hongkong.aliyuncs.com/android-web/spring:latest -q)
            docker rm -f $(docker ps -a --filter ancestor=registry.cn-hongkong.aliyuncs.com/android-web/spring:latest -q)
            docker rmi -f $(docker images  registry.cn-hongkong.aliyuncs.com/android-web/spring:latest -q)
            docker login --username=凯凡1423 --password 001008ma registry.cn-hongkong.aliyuncs.com
            docker pull registry.cn-hongkong.aliyuncs.com/android-web/spring:latest
            docker run -d -p 80:8081 registry.cn-hongkong.aliyuncs.com/android-web/spring:latest
            
            
